#!/usr/bin/env python

import os
import sys

try:
    import paramiko
except ImportError:
    print ("Cannot import paramiko library (https://github.com/paramiko/paramiko), ",
                     "install and rerun %s" % sys.argv[0])


__author__ = "Marek Denis <marek.denis@cern.ch>"
__version__ = "BETA0.1"

NAME = sys.argv[0]

def usage():
    print "Usage: %s <data file>" % NAME

def fetch(filename):
    try:
        with open(filename,'r') as fn:
            for line in fn:
                if line.startswith('#'):
                    continue
                yield line
    except IOError,e:
        print e

def main():
    try:
        files,command = sys.argv[1:3]
    except IndexError,ValueError:
        return usage()

    for line in fetch(files):
        host, passwd = line.split()
        ssh = paramiko.SSHClient()
        ssh.load_system_host_keys()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        try:
            ssh.connect(host,username='root',password=passwd)
            stdin,stdout,stderr = ssh.exec_command(command)
            print stdout.read()
        except paramiko.SSHException:
            print "Cannot execute connection to host: %s, skipping" % (host,)
        finally:
            ssh.close()

if __name__ == "__main__":
    main()

